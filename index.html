<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapLogic + LiveAvatar Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        /* Container for the video stream */
        #avatar-container {
            width: 500px;
            height: 500px;
            background-color: #000;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Status Label */
        #status {
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #555;
            font-weight: 600;
            min-height: 20px;
        }

        /* Controls Area */
        .controls {
            width: 500px;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: #007bff;
        }

        button {
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Helper classes */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="avatar-container">
        <video id="avatar-video" autoplay playsinline></video>
    </div>

    <div id="status">Status: Ready to connect</div>

    <button id="start-btn" onclick="startSession()">Start Avatar Session</button>

    <div id="chat-box" class="controls hidden">
        <input type="text" id="user-input" placeholder="Type a message to SnapLogic..." disabled>
        <button id="send-btn" onclick="handleUserSend()" disabled>Send</button>
    </div>

<script type="module">
    // --- IMPORT SDK ---
    // We import directly from the CDN as an ES Module to fix the "undefined" error
    import StreamingAvatar, { AvatarQuality, TaskType } from "https://cdn.jsdelivr.net/npm/@heygen/streaming-avatar@1.0.5/+esm";

    // --- CONFIGURATION SECTION ---
    
    // 1. SNAPLOGIC CREDENTIALS
    const SL_URL = "https://elastic.snaplogic.com/api/1/rest/slsched/feed/YOUR_SNAPLOGIC_TASK_URL";
    const SL_TOKEN = "Tj7HaMlFj9CSd8wm98BwHQ4NHimHPCL1"; 

    // 2. HEYGEN CREDENTIALS
    // Paste the temporary token you generated via curl or Postman here
    const HEYGEN_ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjNWZmNzA0NmU2YzY0NzE2YTJlNTVjM2QxYjFmNTljNyIsInNlc3Npb25faWQiOiIyYzdlYWIwZi03MjkyLTQwNjEtYjg5NC01ZDFiNTBjZmQ5ZmEiLCJzb3VyY2UiOiJBUEkiLCJzdGFydF9zZXNzaW9uX2RhdGEiOnsibW9kZSI6IkNVU1RPTSIsImF2YXRhcl9pZCI6ImRjMjkzNWNmLTU4NjMtNGYwOC05NDNiLWM3NDc4YWVhNTlmYiIsImlzX3NhbmRib3giOmZhbHNlLCJsaXZla2l0X2NvbmZpZyI6bnVsbCwiYWdvcmFfY29uZmlnIjpudWxsfSwiZXhwIjoxNzY5NTM2NjQyfQ.9H6s8FsbHx5b2u6r1BpOrcP1FvLUoYwEDJ-cUU_rlKk";
    
    // 3. AVATAR CONFIG
    const AVATAR_ID = "afb36080-1731-42c3-a7f4-520ed77159d9"; 

    // --- STATE VARIABLES ---
    let avatar = null;
    let sessionData = null;

    // --- DOM ELEMENTS ---
    const videoElement = document.getElementById('avatar-video');
    const statusLabel = document.getElementById('status');
    const startBtn = document.getElementById('start-btn');
    const chatBox = document.getElementById('chat-box');
    const sendBtn = document.getElementById('send-btn');
    const inputField = document.getElementById('user-input');

    // --- FUNCTIONS ---

    // 1. Start the Session
    // Attached to window so the HTML 'onclick' can find it
    window.startSession = async function() {
        statusLabel.innerText = "Status: Initializing connection...";
        startBtn.disabled = true;

        try {
            // Initialize the SDK
            avatar = new StreamingAvatar({
                token: HEYGEN_ACCESS_TOKEN
            });

            // Start the Video Stream
            sessionData = await avatar.createStartAvatar({
                quality: AvatarQuality.High,
                avatarName: AVATAR_ID,
            });

            // Handle the video stream event
            avatar.on('stream-ready', (event) => {
                // Attach the stream to our <video> element
                videoElement.srcObject = event.detail;
                videoElement.play().catch(console.error);
            });

            // Handle disconnection
            avatar.on('stream-disconnected', () => {
                statusLabel.innerText = "Status: Disconnected";
                resetUI();
            });

            // Update UI to "Chat Mode"
            statusLabel.innerText = "Status: Online. Waiting for input.";
            startBtn.classList.add('hidden');
            chatBox.classList.remove('hidden');
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();

        } catch (error) {
            console.error("Avatar Error:", error);
            statusLabel.innerText = "Error: " + error.message;
            startBtn.disabled = false;
        }
    };

    // 2. Handle Sending Message
    window.handleUserSend = async function() {
        const text = inputField.value;
        if (!text) return;

        // Disable input while processing
        inputField.disabled = true;
        sendBtn.disabled = true;
        
        try {
            // A. Send to SnapLogic
            const replyText = await sendToSnapLogic(text);

            // B. Make Avatar Speak
            if (replyText && avatar) {
                statusLabel.innerText = "Status: Avatar speaking...";
                await avatar.speak({ 
                    text: replyText,
                    task_type: TaskType.REPEAT 
                });
            }
            statusLabel.innerText = "Status: Ready for next question.";

        } catch (error) {
            statusLabel.innerText = "Error: Failed to process.";
        } finally {
            // Re-enable input
            inputField.value = "";
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();
        }
    };

    // 3. Helper: Call SnapLogic Pipeline
    async function sendToSnapLogic(userMessage) {
        statusLabel.innerText = "Status: Sending to SnapLogic...";
        
        try {
            const response = await fetch(SL_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${SL_TOKEN}`
                },
                body: JSON.stringify({ message: userMessage })
            });

            if (!response.ok) {
                throw new Error(`SnapLogic responded with ${response.status}`);
            }

            const data = await response.json();
            
            // NOTE: Ensure your SnapLogic pipeline returns JSON with a 'reply' field!
            // Example: { "reply": "Hello, I am the avatar." }
            return data.reply || "I received the message but got no reply text.";

        } catch (error) {
            console.error("SnapLogic Request Failed:", error);
            statusLabel.innerText = "Status: Pipeline Error";
            return "I am having trouble connecting to the backend.";
        }
    }

    // 4. Handle "Enter" Key in Input Box
    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !sendBtn.disabled) {
            window.handleUserSend();
        }
    });

    // 5. Cleanup on Window Close
    function resetUI() {
        startBtn.classList.remove('hidden');
        chatBox.classList.add('hidden');
        startBtn.disabled = false;
    }

    window.addEventListener('beforeunload', () => {
        if (avatar) avatar.stopAvatar();
    });

</script>
</body>
</html>

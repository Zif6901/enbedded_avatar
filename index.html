<script>
        let currentRoom = null;

        function updateStatus(msg) {
            document.getElementById('status').innerText = msg;
            console.log(`[Status] ${msg}`);
        }

        async function initSession() {
            const token = document.getElementById('sessionToken').value.trim();
            if (!token) {
                alert("Please enter a valid Session Token.");
                return;
            }

            updateStatus("Starting session...");

            try {
                const response = await fetch('https://api.liveavatar.com/v1/sessions/start', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error (${response.status}): ${errorText}`);
                }
                
                const data = await response.json();
                
                // --- DEBUGGING STEP ---
                // Open your browser console (F12) to see this output
                console.log("Full API Response:", data); 

                // Attempt to find the correct keys. 
                // Common variations: data.url, data.ws_url, data.livekit_url
                const liveKitUrl = data.url || data.ws_url || data.livekit_url;
                
                // Common variations: data.access_token, data.token
                const liveKitToken = data.access_token || data.token;

                if (!liveKitUrl || !liveKitToken) {
                    throw new Error("Could not find 'url' or 'token' in API response. Check console for structure.");
                }

                await connectToLiveKit(liveKitUrl, liveKitToken);

            } catch (error) {
                updateStatus(`Error: ${error.message}`);
                console.error(error);
            }
        }

        async function connectToLiveKit(url, token) {
            updateStatus(`Connecting to LiveKit... (URL: ${url})`);

            try {
                currentRoom = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                });

                currentRoom.on(LivekitClient.RoomEvent.TrackSubscribed, handleTrackSubscribed);
                currentRoom.on(LivekitClient.RoomEvent.Disconnected, handleDisconnect);
                
                // This is where your error was happening
                await currentRoom.connect(url, token);
                
                updateStatus("Connected! Waiting for avatar video...");
                document.getElementById('disconnectBtn').disabled = false;

            } catch (error) {
                updateStatus(`LiveKit Connection Failed: ${error.message}`);
                console.error("LiveKit Connect Error:", error);
            }
        }

        function handleTrackSubscribed(track, publication, participant) {
            console.log("Track subscribed:", track.kind);
            const element = track.attach();
            document.getElementById('video-container').appendChild(element);
        }

        function handleDisconnect() {
            updateStatus("Disconnected.");
            const container = document.getElementById('video-container');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            document.getElementById('disconnectBtn').disabled = true;
            currentRoom = null;
        }

        async function disconnect() {
            if (currentRoom) {
                await currentRoom.disconnect();
            }
        }
    </script>
